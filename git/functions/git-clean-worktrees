#!/bin/bash

#
# Removes worktrees that don't have a corresponding remote branch.
# By default, runs in dry-run mode showing what would be deleted.
# Use -f or --force to actually delete the worktrees.
#

force=false
if [[ "$1" == "-f" ]] || [[ "$1" == "--force" ]]; then
  force=true
fi

git worktree list --porcelain |
  awk '/^worktree/ {wt=$2} /^branch/ {br=$2; gsub(/refs\/heads\//, "", br)} /^branch/ && wt && br {print wt"|"br; wt=""; br=""}' |
  while IFS='|' read -r worktree branch; do
    if ! git ls-remote --heads origin "$branch" 2>/dev/null | grep -q "refs/heads/$branch"; then
      if [ "$force" = true ]; then
        echo "Removing worktree: $worktree (branch: $branch)"
        git worktree remove "$worktree"
      else
        echo "Would remove: $worktree (branch: $branch)"
      fi
    fi
  done

if [ "$force" = false ]; then
  echo ""
  echo "Run 'git clean-worktrees -f' to actually remove these worktrees"
fi
